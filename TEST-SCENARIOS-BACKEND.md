# ListenTogether 后端攻防测试场景文档

> 生成日期: 2026-02-21
> 测试目标: Go 服务端 (frp-fan.com:45956)
> 版本: 基于当前代码库分析

## ⚠️ 关键发现：测试模式限制已放开

代码中存在大量 `TODO: restore to X after testing` 注释，以下限制当前被设为极大值(9999/99999)：
- `maxWSConnsPerUser` = 9999 (应为5)
- `msgRateLimit` = 9999 (应为10)
- `pingRateLimit` = 9999 (应为5)
- `totalRateLimit` = 9999 (应为12)
- `MaxRooms` = 99999 (应为100)
- `MaxRoomsPerUser` = 99999 (应为3)
- `MaxClientsPerRoom` = 99999 (应为50)
- 注册/登录限流 = 9999 (应为5)

**这是生产环境的致命风险！**

---

## A. 认证与授权攻防 (12场景)

### A1. JWT密钥弱化攻击
- **严重程度**: 🔴致命
- **攻击向量**: 若JWT_SECRET环境变量设置过短，代码会用随机字节填充，但如果攻击者知道原始短密钥，可尝试暴力破解
- **测试步骤**: 1. 检查JWT_SECRET长度 2. 尝试常见弱密钥签名JWT
- **实际风险**: 代码有`padSecretIfNeeded()`保护，但警告日志会泄露密钥长度信息
- **应对策略**: 强制要求32字节以上密钥，启动时拒绝弱密钥

### A2. JWT算法混淆攻击
- **严重程度**: 🟡高危
- **攻击向量**: 尝试将JWT header中的alg改为none或RS256
- **测试步骤**: 1. 获取有效JWT 2. 修改alg为none 3. 发送请求
- **实际风险**: ✅已防护 - `jwt.WithValidMethods([]string{"HS256"})`限制了算法

### A3. 密码版本绕过
- **严重程度**: 🟡高危
- **攻击向量**: 修改密码后旧token应失效，测试是否真正失效
- **测试步骤**: 1. 登录获取token 2. 修改密码 3. 用旧token访问
- **实际风险**: ✅已防护 - `password_version`和`session_version`机制有效

### A4. 角色缓存投毒
- **严重程度**: 🟡高危
- **攻击向量**: 利用5秒缓存窗口，在角色变更后继续使用旧权限
- **测试步骤**: 1. admin降级为user 2. 5秒内快速操作
- **实际风险**: ⚠️存在5秒窗口期，但`GlobalRoleCache.Invalidate()`会在角色变更时清除

### A5. 暴力破解登录
- **严重程度**: 🔴致命
- **攻击向量**: 当前限流=9999，可无限尝试密码
- **测试步骤**: 1. 对单用户发起大量登录请求 2. 观察是否被限制
- **实际风险**: 🔴当前无防护！`loginLimiter.allow(ip, 9999, time.Minute)`
- **应对策略**: 恢复为5次/分钟限制

### A6. 用户名枚举
- **严重程度**: 🟢中危
- **攻击向量**: 通过登录错误信息区分"用户不存在"和"密码错误"
- **测试步骤**: 1. 用不存在用户名登录 2. 用存在用户名+错误密码登录 3. 对比响应
- **实际风险**: ✅已防护 - 统一返回"用户名或密码错误"

### A7. Cookie注入攻击
- **严重程度**: 🟢中危
- **攻击向量**: 尝试注入恶意cookie值
- **测试步骤**: 1. 设置token cookie为恶意值 2. 观察服务器行为
- **实际风险**: ✅已防护 - JWT解析失败会静默忽略

### A8. 会话固定攻击
- **严重程度**: 🟡高危
- **攻击向量**: 登录前后session token是否变化
- **测试步骤**: 1. 获取未登录状态的任何标识 2. 登录 3. 检查是否生成新token
- **实际风险**: ✅已防护 - 登录时生成全新JWT

### A9. 默认owner密码
- **严重程度**: 🔴致命
- **攻击向量**: 默认admin/admin123未修改
- **测试步骤**: 1. 尝试admin/admin123登录
- **实际风险**: ⚠️代码有`needChangePassword`提示，但不强制
- **应对策略**: 首次登录强制修改密码

### A10. 并发登录竞态
- **严重程度**: 🟢中危
- **攻击向量**: 同时从多处登录同一账户
- **测试步骤**: 1. 并发发起100个登录请求 2. 检查session状态
- **实际风险**: ✅设计允许多设备登录，session_version仅在密码修改时递增

### A11. Token自动续期滥用
- **严重程度**: 🟢中危
- **攻击向量**: 利用<2小时自动续期机制保持永久会话
- **测试步骤**: 1. 获取token 2. 等待22小时 3. 发请求触发续期 4. 重复
- **实际风险**: ⚠️理论上可无限续期，但需要持续活动

### A12. X-Forwarded-For欺骗绕过限流
- **严重程度**: 🟡高危
- **攻击向量**: 伪造XFF头绕过IP限流
- **测试步骤**: 1. 设置X-Forwarded-For: 1.2.3.4 2. 发起请求
- **实际风险**: ✅已防护 - 仅在TRUSTED_PROXIES配置时才信任XFF

---

## B. WebSocket协议攻防 (11场景)

### B1. 未认证WebSocket连接
- **严重程度**: 🔴致命
- **攻击向量**: 不带token直接连接/ws
- **测试步骤**: 1. wscat -c ws://target/ws (无cookie)
- **实际风险**: ✅已防护 - `ExtractUserFromRequest`检查，返回401

### B2. 消息洪泛攻击
- **严重程度**: 🔴致命
- **攻击向量**: 当前限流=9999，可发送海量消息
- **测试步骤**: 1. 连接WS 2. 循环发送消息 3. 观察服务器负载
- **实际风险**: 🔴当前无防护！
- **应对策略**: 恢复`msgRateLimit=10`, `totalRateLimit=12`

### B3. 超大消息攻击
- **严重程度**: 🟡高危
- **攻击向量**: 发送超过64KB的消息
- **测试步骤**: 1. 构造65KB JSON 2. 发送
- **实际风险**: ✅已防护 - `conn.SetReadLimit(65536)`

### B4. 畸形JSON注入
- **严重程度**: 🟢中危
- **攻击向量**: 发送非法JSON
- **测试步骤**: 1. 发送`{invalid json` 2. 观察连接状态
- **实际风险**: ✅已防护 - `ReadJSON`失败会break循环关闭连接

### B5. 连接耗尽攻击
- **严重程度**: 🔴致命
- **攻击向量**: 当前maxWSConnsPerUser=9999
- **测试步骤**: 1. 单用户建立1000个WS连接
- **实际风险**: 🔴当前无防护！
- **应对策略**: 恢复`maxWSConnsPerUser=5`

### B6. Ping洪泛攻击
- **严重程度**: 🔴致命
- **攻击向量**: 当前pingRateLimit=9999
- **测试步骤**: 1. 循环发送ping消息
- **实际风险**: 🔴当前无防护！

### B7. 跨房间操作
- **严重程度**: 🟡高危
- **攻击向量**: 在A房间发送针对B房间的控制命令
- **测试步骤**: 1. 加入房间A 2. 发送play命令带roomCode:B
- **实际风险**: ✅已防护 - 操作基于`currentRoom`变量，不使用消息中的roomCode

### B8. 房间代码枚举
- **严重程度**: 🟡高危
- **攻击向量**: 暴力枚举8位hex房间码
- **测试步骤**: 1. 循环发送join消息尝试不同roomCode
- **实际风险**: ⚠️有`joinLimiter`但当前设为30次/分钟，仍可慢速枚举
- **应对策略**: 降低到5次/分钟，增加房间码长度

### B9. 并发写入竞态
- **严重程度**: 🟡高危
- **攻击向量**: gorilla/websocket不支持并发写入
- **测试步骤**: 1. 触发broadcast同时客户端发消息
- **实际风险**: ✅已防护 - `Client.mu`互斥锁保护写入

### B10. Pong处理器注入
- **严重程度**: 🟢中危
- **攻击向量**: 发送恶意pong帧
- **测试步骤**: 1. 发送WebSocket pong控制帧
- **实际风险**: ✅已防护 - pong handler仅更新deadline

### B11. Origin绕过
- **严重程度**: 🟡高危
- **攻击向量**: 不设置ALLOWED_ORIGINS时允许任意origin
- **测试步骤**: 1. 从恶意网站发起WS连接
- **实际风险**: ⚠️默认permissive模式，需配置ALLOWED_ORIGINS

---

## C. 房间管理极端场景 (10场景)

### C1. 房间爆炸攻击
- **严重程度**: 🔴致命
- **攻击向量**: 当前MaxRooms=99999
- **测试步骤**: 1. 循环创建房间直到内存耗尽
- **实际风险**: 🔴当前无防护！
- **应对策略**: 恢复`MaxRooms=100`, `MaxRoomsPerUser=3`

### C2. 幽灵客户端
- **严重程度**: 🟢中危
- **攻击向量**: 连接后不发心跳，占用资源
- **测试步骤**: 1. 连接WS 2. 加入房间 3. 静默30秒
- **实际风险**: ✅已防护 - 30秒ReadDeadline + ping/pong机制

### C3. 房主转移竞态
- **严重程度**: 🟡高危
- **攻击向量**: 房主断开瞬间多人同时操作
- **测试步骤**: 1. 房主断开 2. 同时发送多个控制命令
- **实际风险**: ✅已防护 - `Room.Mu`锁保护Host转移

### C4. 踢人+重连竞态
- **严重程度**: 🟢中危
- **攻击向量**: 被踢用户立即重连
- **测试步骤**: 1. 房主踢人 2. 被踢者立即重连
- **实际风险**: ✅允许重连，这是预期行为

### C5. 同用户多连接
- **严重程度**: 🟢中危
- **攻击向量**: 同一用户多次加入同一房间
- **测试步骤**: 1. 用户A连接1加入房间 2. 用户A连接2加入同房间
- **实际风险**: ✅已防护 - `AddClient`会关闭同UID旧连接

### C6. 房间清理竞态
- **严重程度**: 🟢中危
- **攻击向量**: 清理goroutine运行时有人加入
- **测试步骤**: 1. 等待房间即将被清理 2. 此时加入
- **实际风险**: ✅已防护 - 清理前会再次检查ClientCount

### C7. 空房间资源泄漏
- **严重程度**: 🟢中危
- **攻击向量**: 创建房间后立即离开
- **测试步骤**: 1. 创建房间 2. 立即断开 3. 重复
- **实际风险**: ✅已防护 - 30分钟不活跃自动清理

### C8. 非房主控制尝试
- **严重程度**: 🟡高危
- **攻击向量**: 普通用户发送play/pause/seek
- **测试步骤**: 1. 以普通用户加入 2. 发送play命令
- **实际风险**: ✅已防护 - 双重检查`IsHost`和`OwnerID`

### C9. 房间码碰撞
- **严重程度**: ⚪低危
- **攻击向量**: 8位hex码碰撞概率
- **测试步骤**: 理论分析：4字节=2^32可能，碰撞概率极低
- **实际风险**: ✅可接受 - 碰撞时会覆盖旧房间

### C10. closeRoom后继续操作
- **严重程度**: 🟢中危
- **攻击向量**: 房间关闭后发送命令
- **测试步骤**: 1. 关闭房间 2. 立即发送play
- **实际风险**: ✅已防护 - `currentRoom`被设为nil

---

## D. 播放控制与同步攻防 (8场景)

### D1. NaN/Infinity Position
- **严重程度**: 🟡高危
- **攻击向量**: 发送position: NaN或Infinity
- **测试步骤**: 1. 发送`{"type":"play","position":NaN}`
- **实际风险**: ✅已防护 - `validatePosition`检查`math.IsNaN`和`math.IsInf`

### D2. 负数Position
- **严重程度**: 🟢中危
- **攻击向量**: 发送position: -100
- **测试步骤**: 1. 发送`{"type":"seek","position":-100}`
- **实际风险**: ✅已防护 - `validatePosition`检查`pos < 0`

### D3. 超时长Position
- **严重程度**: 🟢中危
- **攻击向量**: 发送超过音频时长的position
- **测试步骤**: 1. 发送`{"type":"seek","position":99999}`
- **实际风险**: ✅已防护 - `validatePosition`检查`pos > duration`

### D4. Seek洪泛
- **严重程度**: 🔴致命
- **攻击向量**: 高频发送seek命令
- **测试步骤**: 1. 循环发送seek 2. 观察其他客户端
- **实际风险**: 🔴当前无防护！msgRateLimit=9999

### D5. statusReport伪造
- **严重程度**: 🟢中危
- **攻击向量**: 发送虚假的播放状态报告
- **测试步骤**: 1. 发送错误的trackIndex和position
- **实际风险**: ✅已防护 - 服务器会发送forceTrack/forceResync纠正

### D6. forceResync循环
- **严重程度**: 🟢中危
- **攻击向量**: 故意保持drift>400ms触发持续resync
- **测试步骤**: 1. 客户端故意延迟播放
- **实际风险**: ⚠️可能造成日志洪泛，但不影响其他用户

### D7. syncTick竞态
- **严重程度**: 🟢中危
- **攻击向量**: syncTick goroutine与房间操作竞态
- **测试步骤**: 1. 在syncTick执行时关闭房间
- **实际风险**: ✅已防护 - 使用RLock读取，clients列表是副本

### D8. trackChange越权
- **严重程度**: 🟡高危
- **攻击向量**: 非房主发送nextTrack
- **测试步骤**: 1. 普通用户发送nextTrack
- **实际风险**: ✅已防护 - 检查`OwnerID != userID`

---

## E. 数据库与存储攻防 (9场景)

### E1. SQL注入
- **严重程度**: 🔴致命
- **攻击向量**: 用户名/密码字段注入
- **测试步骤**: 1. 注册用户名`admin'--`
- **实际风险**: ✅已防护 - 使用参数化查询`?`占位符

### E2. 并发写入竞态
- **严重程度**: 🟢中危
- **攻击向量**: 并发创建用户导致UID冲突
- **测试步骤**: 1. 并发注册100个用户
- **实际风险**: ✅已防护 - 事务+重试机制(maxRetries=3)

### E3. 大payload存储
- **严重程度**: 🟡高危
- **攻击向量**: user_settings存储超大JSON
- **测试步骤**: 1. PUT /api/user/settings 发送1MB JSON
- **实际风险**: ⚠️无大小限制，但全局1MB body limit保护

### E4. 文件路径遍历
- **严重程度**: 🔴致命
- **攻击向量**: 访问`../../../etc/passwd`
- **测试步骤**: 1. GET /api/library/segments/1/../../../etc/passwd
- **实际风险**: ✅已防护 - `filepath.Base()`和`..`检查

### E5. 音频文件越权访问
- **严重程度**: 🟡高危
- **攻击向量**: 访问他人未共享的音频
- **测试步骤**: 1. 获取他人audioID 2. 请求其segments
- **实际风险**: ✅已防护 - `CanAccessAudioFile`检查所有权/共享

### E6. 上传恶意文件
- **严重程度**: 🟡高危
- **攻击向量**: 上传伪装成音频的恶意文件
- **测试步骤**: 1. 上传.mp3扩展名的PHP文件
- **实际风险**: ✅已防护 - `isAudioMagic`检查文件头魔数

### E7. 磁盘耗尽攻击
- **严重程度**: 🟡高危
- **攻击向量**: 上传大量50MB文件
- **测试步骤**: 1. 循环上传直到磁盘满
- **实际风险**: ⚠️无用户配额限制
- **应对策略**: 添加用户存储配额

### E8. ffmpeg命令注入
- **严重程度**: 🔴致命
- **攻击向量**: 文件名包含shell特殊字符
- **测试步骤**: 1. 上传文件名`$(rm -rf /)`
- **实际风险**: ✅已防护 - `sanitizeInputPath`处理`-`开头，exec.Command不经过shell

### E9. 封面图片XSS
- **严重程度**: 🟢中危
- **攻击向量**: 上传SVG封面包含JS
- **测试步骤**: 1. 上传含`<script>`的SVG
- **实际风险**: ✅已防护 - 封面强制转换为JPEG

---

## F. API安全攻防 (9场景)

### F1. CORS绕过
- **严重程度**: 🟡高危
- **攻击向量**: 未配置ALLOWED_ORIGINS时
- **测试步骤**: 1. 从恶意域发起请求
- **实际风险**: ⚠️HTTP API无CORS头设置，依赖cookie SameSite

### F2. CSRF攻击
- **严重程度**: 🟡高危
- **攻击向量**: 诱导用户点击恶意链接执行操作
- **测试步骤**: 1. 构造恶意表单POST到/api/auth/logout
- **实际风险**: ✅已防护 - Cookie设置`SameSite: Strict`

### F3. 请求体超限
- **严重程度**: 🟢中危
- **攻击向量**: 发送超大请求体
- **测试步骤**: 1. POST 10MB数据到/api/auth/login
- **实际风险**: ✅已防护 - 全局1MB限制，上传50MB限制

### F4. HTTP方法混淆
- **严重程度**: 🟢中危
- **攻击向量**: 用GET请求POST端点
- **测试步骤**: 1. GET /api/auth/login
- **实际风险**: ✅已防护 - 每个handler检查Method

### F5. 管理员API越权
- **严重程度**: 🔴致命
- **攻击向量**: 普通用户访问/api/admin/*
- **测试步骤**: 1. 以user角色访问/api/admin/users
- **实际风险**: ✅已防护 - 检查`user.Role != "owner"`

### F6. 用户UID枚举
- **严重程度**: 🟢中危
- **攻击向量**: 通过共享API枚举用户
- **测试步骤**: 1. POST /api/library/share 尝试不同UID
- **实际风险**: ⚠️返回"用户不存在"可确认UID有效性

### F7. 信息泄露
- **严重程度**: 🟢中危
- **攻击向量**: 错误信息泄露内部细节
- **测试步骤**: 1. 触发各种错误 2. 检查响应
- **实际风险**: ✅已防护 - 错误信息为中文用户友好提示

### F8. 管理员删除owner
- **严重程度**: 🔴致命
- **攻击向量**: 尝试删除owner账户
- **测试步骤**: 1. DELETE /api/admin/users/{owner_uid}
- **实际风险**: ✅已防护 - 检查`target.Role == "owner"`

### F9. 播放列表越权操作
- **严重程度**: 🟡高危
- **攻击向量**: 非房主修改播放列表
- **测试步骤**: 1. 以普通用户POST /api/room/{code}/playlist/add
- **实际风险**: ✅已防护 - `isRoomOwner`检查

---

## 风险汇总表

| 严重程度 | 数量 | 关键问题 |
|---------|------|---------|
| 🔴致命 | 8 | 限流全部放开(TODO未恢复)、默认密码 |
| 🟡高危 | 15 | 缓存窗口、Origin配置、存储配额 |
| 🟢中危 | 25 | 日志泄露、UID枚举、理论攻击 |
| ⚪低危 | 2 | 房间码碰撞等 |

## 立即修复清单

1. **恢复所有TODO限制** - 搜索`TODO: restore`并修复
2. **强制修改默认密码** - owner首次登录必须改密码
3. **配置ALLOWED_ORIGINS** - 生产环境必须设置
4. **添加用户存储配额** - 防止磁盘耗尽
5. **增加房间码长度** - 从8位增加到12位
